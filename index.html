<!DOCTYPE html>
<html lang="id" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸŒŒ DREAM OS v4.2 FINAL â€¢ SIF Al Fikri General Affairs</title>
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- ALL-IN-ONE FIXED CSS -->
    <style>
        :root {
            --primary: #0a0a2a; --secondary: #00d4ff; --accent: #2E7D32;
            --danger: #ff3860; --warning: #FF9800; --purple: #9c27b0;
            --orange: #FF9800; --light: rgba(255,255,255,0.9);
            --card-bg: rgba(255,255,255,0.05); --card-border: rgba(0,212,255,0.3);
            --quantum: #9C27B0; --architect: #FF9800;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background:var(--primary); color:white; min-height:100vh; overflow-x:hidden; }
        
        /* HEADER - DENGAN QUANTUM ACCESS */
        .header { 
            background: linear-gradient(135deg, #2D5D4B 0%, #1E293B 100%);
            padding: 1.2rem 1rem; 
            text-align: center; 
            border-bottom: 2px solid var(--secondary);
            animation: headerGlow 3s infinite alternate;
            position: relative;
            cursor: pointer;
        }
        
        .header::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1rem;
            opacity: 0.3;
            transition: all 0.3s;
        }
        
        .header:hover::after {
            opacity: 0.7;
            transform: scale(1.2);
        }
        
        @keyframes headerGlow { 
            0% { border-color: #00d4ff } 
            50% { border-color: #2E7D32 } 
            100% { border-color: #9c27b0 } 
        }
        
        .arabic { 
            font-family: 'Amiri', serif;
            font-size: 1.8rem; 
            color: #4CAF50; 
            margin-bottom: 0.5rem; 
            font-weight: 700; 
        }
        
        .shalawat { 
            font-size: 1.1rem; 
            color: var(--warning); 
            margin-bottom: 0.5rem; 
            font-style: italic;
        }
        
        /* NAVIGASI FIXED BOTTOM */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(10,10,42,0.97); 
            display: flex; 
            padding: 0.8rem 0.5rem; 
            backdrop-filter: blur(15px); 
            z-index: 1000;
            border-top: 1px solid rgba(0,212,255,0.2); 
        }
        
        .nav-item { 
            flex: 1; 
            text-align: center; 
            color: rgba(255,255,255,0.6); 
            padding: 0.7rem 0.5rem; 
            font-size: 0.75rem; 
            cursor: pointer; 
            transition: all 0.4s; 
            border-radius: 12px; 
        }
        
        .nav-item.active { 
            color: var(--secondary); 
            background: rgba(0,212,255,0.15); 
            transform: translateY(-8px); 
        }
        
        .nav-icon { 
            display: block; 
            font-size: 1.5rem; 
            margin-bottom: 0.4rem; 
        }
        
        /* CONTENT AREA */
        .content { 
            padding: 1.5rem; 
            padding-bottom: 120px; 
            max-width: 800px; 
            margin: 0 auto; 
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CARD DESIGN */
        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            padding: 1.8rem; 
            margin: 1.5rem 0; 
            border: 1px solid var(--card-border); 
            transition: all 0.4s; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--accent)); 
            border-radius: 20px 20px 0 0;
        }
        
        /* BUTTONS */
        .btn { 
            width: 100%; 
            padding: 1.2rem; 
            background: linear-gradient(135deg, var(--accent), #4CAF50); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 1.1rem; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 1.5rem; 
            transition: all 0.4s; 
            position: relative; 
            overflow: hidden; 
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        /* FORM ELEMENTS */
        .form-group { margin-bottom: 1.5rem; }
        
        .form-label { 
            display: block; 
            margin-bottom: 0.7rem; 
            color: var(--secondary); 
            font-weight: 600; 
            font-size: 0.9rem;
        }
        
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 1rem; 
            background: rgba(255,255,255,0.08); 
            border: 2px solid rgba(0,212,255,0.4); 
            border-radius: 10px; 
            color: white; 
            font-size: 1rem; 
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; 
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
            background: rgba(255,255,255,0.12);
        }
        
        /* NOTIFICATION */
        .notification { 
            position: fixed; 
            top: 90px; 
            right: 20px; 
            background: var(--accent); 
            color: white; 
            padding: 1.2rem 1.5rem; 
            border-radius: 12px; 
            z-index: 9998; 
            max-width: 350px; 
            animation: slideIn 0.5s; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--primary);
            padding: 2rem;
            border-radius: 20px;
            border: 2px solid var(--secondary);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) { 
            .content { padding: 1rem; padding-bottom: 100px; } 
            .card { padding: 1.3rem; }
            .arabic { font-size: 1.5rem; }
        }
        
        @media (max-width: 480px) {
            .nav-item { font-size: 0.7rem; padding: 0.5rem; }
            .nav-icon { font-size: 1.3rem; }
        }
        
        /* QUANTUM BADGE */
        .quantum-badge {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--quantum);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
            z-index: 9997;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- QUANTUM ACCESS BADGE -->
    <div id="quantumBadge" class="quantum-badge">ğŸŒŒ QUANTUM ACCESS</div>
    
    <!-- HEADER -->
    <div class="header" onclick="handleHeaderClick()">
        <div class="arabic">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ’Ù…Ù</div>
        <div class="shalawat" id="dynamicShalawat">Ø§ÙÙ„Ù„Ù‘Ù°Ù‡ÙÙ…ÙÙ‘ ØµÙÙ„ÙÙ‘ Ø¹ÙÙ„ÙÙ‰ Ø³ÙÙŠÙÙ‘Ø¯ÙÙ†ÙØ§ Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù</div>
        <div class="subtitle">ğŸŒŒ DREAM OS v4.2 FINAL â€¢ <span id="greeting">SIF Al Fikri GA</span></div>
    </div>
    
    <!-- CONTENT AREA -->
    <div id="content" class="content">
        <!-- Default Home Content akan dimuat di sini -->
    </div>
    
    <!-- NAVIGATION -->
    <div class="nav">
        <div class="nav-item active" onclick="showView('home')"><div class="nav-icon">ğŸ </div><div>Home</div></div>
        <div class="nav-item" onclick="showView('booking')"><div class="nav-icon">ğŸ“…</div><div>Booking</div></div>
        <div class="nav-item" onclick="showView('k3')"><div class="nav-icon">âš ï¸</div><div>K3</div></div>
        <div class="nav-item" onclick="showView('inventory')"><div class="nav-icon">ğŸ”§</div><div>Inventory</div></div>
        <div class="nav-item" onclick="showView('admin')"><div class="nav-icon">ğŸ”</div><div>Admin</div></div>
    </div>
    
    <!-- NOTIFICATION -->
    <div id="notification" class="notification"></div>
    
    <!-- MODAL UNTUK KAMERA -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--secondary); margin-bottom: 1.5rem;">ğŸ“¸ Ambil Foto K3</h3>
            <div id="cameraView" style="width: 100%; max-width: 500px; margin: 0 auto; background: #000; border-radius: 10px; overflow: hidden;">
                <video id="cameraVideo" autoplay style="width: 100%;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button onclick="capturePhoto()" class="btn" style="background: var(--secondary);">ğŸ“¸ Capture</button>
                <button onclick="closeCamera()" class="btn" style="background: var(--danger);">âœ• Close</button>
            </div>
        </div>
    </div>

    <!-- ALL-IN-ONE JAVASCRIPT - SUPABASE INTEGRATION -->
    <script>
// ==================== SUPABASE CONFIGURATION ====================
const SUPABASE_CONFIG = {
    url: 'https://ywtypkgjvbjwhmapmygb.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3dHB5a2dqdmJqd2htYXBteWdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTI5OTcsImV4cCI6MjA4MjQ4ODk5N30.MA78j8WLwOO9nxR36tikN7jBQLjbYWYvTZn___eXBkk'
};

let supabaseClient = null;

// ==================== DREAM OS v4.2 FINAL ====================
const CONFIG = {
    version: '4.2',
    schoolName: 'SIF Al Fikri',
    contactPerson: 'Pak Erwin',
    contactNumber: '08886183954',
    whatsappNumber: '628886183954',
    adminEmail: 'teknisi@alfikri.sch.id',
    
    // Booking Hours Rules
    bookingRules: {
        normalDays: ['Senin', 'Selasa', 'Rabu', 'Kamis'],
        friday: 'Jumat',
        saturday: 'Sabtu',
        sunday: 'Minggu',
        
        normalStart: '07:30',
        normalEnd: '16:00',
        
        fridayStart: '10:30',
        fridayEnd: '13:00',
        
        blockedFacilitiesFriday: ['AULA_SMP', 'SERBAGUNA'],
        maintenanceFacilities: ['MASJID']
    }
};

// ==================== COMPLETE DATA TERBARU ====================
const COMPLETE_DATA = {
    facilities: [
        { id: 'AULA_SMP', name: 'Aula SMP', capacity: 200, equipment: ['sound', 'lighting', 'ac', 'projector'], status: 'available', notes: 'Include sound, lighting, AC, projector' },
        { id: 'AULA_SMA', name: 'Aula SMA', capacity: 150, equipment: ['sound', 'projector'], status: 'available', notes: 'Include sound, projector' },
        { id: 'SAUNG_BESAR', name: 'Saung Besar', capacity: 100, equipment: ['sound'], status: 'available', notes: 'Include sound' },
        { id: 'SAUNG_KECIL', name: 'Saung Kecil', capacity: 50, equipment: [], status: 'available', notes: 'Fasilitas dasar' },
        { id: 'MASJID', name: 'Masjid', capacity: 300, equipment: ['sound'], status: 'maintenance', notes: 'MAINTENANCE/RENOVASI - Tidak bisa digunakan' },
        { id: 'SERBAGUNA', name: 'Serbaguna', capacity: 120, equipment: ['sound'], status: 'available', notes: 'Include sound' },
        { id: 'LABKOM_SD', name: 'Labkom SD', capacity: 30, equipment: ['komputer', 'ac', 'wifi'], status: 'available', notes: 'Lab komputer SD' },
        { id: 'LABKOM_SMP', name: 'Labkom SMP', capacity: 40, equipment: ['komputer', 'projector', 'ac', 'wifi'], status: 'available', notes: 'Lab komputer SMP' },
        { id: 'LABKOM_SMA', name: 'Labkom SMA', capacity: 45, equipment: ['komputer', 'projector', 'ac', 'wifi'], status: 'available', notes: 'Lab komputer SMA' },
        { id: 'VOLI', name: 'Lapangan Volley', capacity: 50, equipment: ['jaring', 'bola'], status: 'available', notes: 'Lapangan voli outdoor' },
        { id: 'BASKET', name: 'Lapangan Basket', capacity: 40, equipment: ['ring', 'bola'], status: 'available', notes: 'Lapangan basket' },
        { id: 'LAP_SMA', name: 'Lapangan SMA', capacity: 100, equipment: [], status: 'available', notes: 'Lapangan serbaguna SMA' },
        { id: 'LAP_TANAH', name: 'Lapangan Tanah', capacity: 150, equipment: [], status: 'available', notes: 'Lapangan tanah serbaguna' },
        { id: 'KANTIN_SMP', name: 'Kantin SMP', capacity: 80, equipment: ['meja', 'kursi'], status: 'available', notes: 'Area makan SMP' },
        { id: 'KANTIN_SMA', name: 'Kantin SMA', capacity: 80, equipment: ['meja', 'kursi'], status: 'available', notes: 'Area makan SMA' },
        { id: 'PERPUS_SD', name: 'Perpus SD', capacity: 40, equipment: ['buku', 'meja', 'kursi', 'ac'], status: 'available', notes: 'Perpustakaan SD' },
        { id: 'PERPUS_SMP', name: 'Perpus SMP', capacity: 50, equipment: ['buku', 'meja', 'kursi', 'ac', 'wifi'], status: 'available', notes: 'Perpustakaan SMP' },
        { id: 'PERPUS_SMA', name: 'Perpus SMA', capacity: 60, equipment: ['buku', 'meja', 'kursi', 'ac', 'wifi'], status: 'available', notes: 'Perpustakaan SMA' }
    ],
    
    units: [
        { id: 'TK', name: 'TK Al Fikri' },
        { id: 'SD', name: 'SD Al Fikri' },
        { id: 'SMP', name: 'SMP Al Fikri' },
        { id: 'SMA', name: 'SMA Al Fikri' },
        { id: 'YAYASAN', name: 'Yayasan Al Fikri' },
        { id: 'UMUM', name: 'Umum/Luar' }
    ],
    
    equipment: [
        { id: 'sound-portable', name: 'Sound Portable', quantity: 8, available: 6, category: 'audio' },
        { id: 'projector', name: 'Projector', quantity: 12, available: 10, category: 'visual' },
        { id: 'mic-standing', name: 'Mic Standing', quantity: 6, available: 4, category: 'audio' },
        { id: 'meja-panjang', name: 'Meja Panjang', quantity: 25, available: 20, category: 'furniture' },
        { id: 'meja-siswa', name: 'Meja Siswa', quantity: 50, available: 45, category: 'furniture' },
        { id: 'meja-oshin', name: 'Meja Oshin', quantity: 15, available: 12, category: 'furniture' },
        { id: 'kursi-futura', name: 'Kursi Futura', quantity: 200, available: 180, category: 'furniture' },
        { id: 'kursi-chitose', name: 'Kursi Chitose', quantity: 150, available: 130, category: 'furniture' },
        { id: 'kursi-siswa', name: 'Kursi Siswa', quantity: 300, available: 280, category: 'furniture' },
        { id: 'kabel-hdmi', name: 'Kabel HDMI', quantity: 20, available: 18, category: 'kabel' },
        { id: 'kabel-vga', name: 'Kabel VGA', quantity: 15, available: 12, category: 'kabel' },
        { id: 'kabel-rol', name: 'Kabel Rol AC (Extension)', quantity: 30, available: 25, category: 'kabel' }
    ],
    
    k3Types: [
        { id: 'kerusakan', name: 'ğŸš¨ Kerusakan', priority: 'high', team: 'Maintenance', color: '#FF9800' },
        { id: 'kebersihan', name: 'ğŸ§¹ Kebersihan', priority: 'medium', team: 'Cleaning', color: '#00d4ff' },
        { id: 'keselamatan', name: 'ğŸ›¡ï¸ Keselamatan', priority: 'critical', team: 'Security', color: '#ff3860' },
        { id: 'listrik', name: 'âš¡ Listrik', priority: 'critical', team: 'Electrician', color: '#FFD700' },
        { id: 'ac', name: 'â„ï¸ AC', priority: 'medium', team: 'Maintenance', color: '#2196F3' },
        { id: 'internet', name: 'ğŸŒ Internet', priority: 'medium', team: 'IT', color: '#9C27B0' }
    ],
    
    k3Locations: [
        'Aula SMP', 'Aula SMA', 'Saung Besar', 'Saung Kecil', 'Masjid', 'Serbaguna',
        'Labkom SD', 'Labkom SMP', 'Labkom SMA', 'Lapangan Volley', 'Lapangan Basket',
        'Lapangan SMA', 'Lapangan Tanah', 'Kantin SMP', 'Kantin SMA', 'Perpus SD',
        'Perpus SMP', 'Perpus SMA', 'Toilet', 'Parkiran', 'Taman', 'Koridor'
    ]
};

// ==================== PASSWORD SYSTEM ====================
const PASSWORD_SYSTEM = {
    user: 'user_@1234',
    admin: '@dm1n_Sec2025',
    architect: '418626',
    vaultInventory: '4dm1in_6969@01',
    vaultWarehouse: '4dm1n_9696@02',
    masterKey: 'Mr.M_Architect_2025'
};

// ==================== APP STATE ====================
let appState = {
    currentView: 'home',
    isAdmin: false,
    isArchitect: false,
    quantumAccess: false,
    capturedPhoto: null,
    cameraStream: null,
    tapPattern: [],
    lastTapTime: 0
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ DREAM OS v4.2 FINAL Loading...');
    
    // Initialize Supabase
    try {
        supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        console.log('âœ… Supabase connected');
    } catch (error) {
        console.error('âŒ Supabase error:', error);
    }
    
    // Initialize localStorage jika kosong
    initLocalStorage();
    
    // Check quantum hours
    checkQuantumHours();
    
    // Show home view
    showView('home');
    
    // Update greeting
    updateGreeting();
    
    // Show welcome notification
    setTimeout(() => {
        showNotification('ğŸŒŒ DREAM OS v4.2 FINAL Ready!', 'success');
    }, 1000);
    
    // Set up keyboard shortcuts
    setupKeyboardShortcuts();
    
    console.log('âœ… DREAM OS v4.2 FINAL Loaded Successfully!');
});

function initLocalStorage() {
    if (!localStorage.getItem('bookings')) {
        localStorage.setItem('bookings', JSON.stringify([]));
    }
    if (!localStorage.getItem('k3_reports')) {
        localStorage.setItem('k3_reports', JSON.stringify([]));
    }
    if (!localStorage.getItem('inventory')) {
        localStorage.setItem('inventory', JSON.stringify(COMPLETE_DATA.equipment));
    }
    if (!localStorage.getItem('users')) {
        localStorage.setItem('users', JSON.stringify([
            { id: 1, name: 'Admin GA', username: 'admin', password: 'admin123', role: 'admin' },
            { id: 2, name: 'User Demo', username: 'user', password: 'user123', role: 'user' }
        ]));
    }
}

// ==================== QUANTUM ACCESS SYSTEM ====================
function checkQuantumHours() {
    const now = new Date();
    const hour = now.getHours();
    // Quantum hours: 02:00-05:00
    if (hour >= 2 && hour < 5) {
        appState.quantumAccess = true;
        document.getElementById('quantumBadge').style.display = 'block';
        console.log('ğŸŒŒ Quantum access granted');
    }
}

function handleHeaderClick() {
    const now = Date.now();
    if (now - appState.lastTapTime > 1000) {
        appState.tapPattern = [];
    }
    
    appState.tapPattern.push(now);
    appState.lastTapTime = now;
    
    // Check for pattern 7-3-1-4 (taps within 3 seconds)
    if (appState.tapPattern.length === 4) {
        const pattern = appState.tapPattern;
        const timePattern = [
            pattern[1] - pattern[0],
            pattern[2] - pattern[1],
            pattern[3] - pattern[2]
        ];
        
        // Check if pattern roughly matches 7-3-1-4 rhythm
        if (timePattern.every((t, i) => t > 50 && t < 1000)) {
            const sorted = [...timePattern].sort((a,b) => a-b);
            if (sorted[0] < 200 && sorted[3] > 600) {
                unlockArchitectMode();
            }
        }
        
        appState.tapPattern = [];
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.altKey && e.key === 'D') {
            unlockArchitectMode();
            e.preventDefault();
        }
        
        // Master key shortcut: Ctrl+Shift+M
        if (e.ctrlKey && e.shiftKey && e.key === 'M') {
            showMasterKeyPrompt();
            e.preventDefault();
        }
    });
}

function unlockArchitectMode() {
    appState.isArchitect = true;
    appState.isAdmin = true;
    document.getElementById('quantumBadge').style.display = 'block';
    document.getElementById('quantumBadge').textContent = 'ğŸ‘‘ ARCHITECT MODE';
    document.getElementById('quantumBadge').style.background = 'var(--architect)';
    
    showNotification('ğŸ‘‘ ARCHITECT MODE UNLOCKED! Full access granted', 'success');
    
    // Show special options
    if (appState.currentView === 'admin') {
        showView('admin');
    }
}

function showMasterKeyPrompt() {
    const key = prompt('ğŸ” Enter Master Key:');
    if (key === PASSWORD_SYSTEM.masterKey) {
        unlockArchitectMode();
    } else if (key) {
        showNotification('âŒ Invalid Master Key', 'error');
    }
}

// ==================== VIEW SYSTEM ====================
function showView(view) {
    appState.currentView = view;
    
    // Update nav active state
    document.querySelectorAll('.nav-item').forEach((item, index) => {
        item.classList.remove('active');
        const views = ['home', 'booking', 'k3', 'inventory', 'admin'];
        if (views[index] === view) item.classList.add('active');
    });
    
    const content = document.getElementById('content');
    
    switch(view) {
        case 'home':
            content.innerHTML = renderHome();
            updateHomeStats();
            break;
        case 'booking':
            content.innerHTML = renderBooking();
            loadFacilityOptions();
            break;
        case 'k3':
            content.innerHTML = renderK3();
            break;
        case 'inventory':
            content.innerHTML = renderInventory();
            loadInventory();
            break;
        case 'admin':
            content.innerHTML = renderAdmin();
            break;
    }
}

// ==================== RENDER FUNCTIONS ====================
function renderHome() {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const k3Reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
    const inventory = JSON.parse(localStorage.getItem('inventory') || JSON.stringify(COMPLETE_DATA.equipment));
    
    const availableFacilities = COMPLETE_DATA.facilities.filter(f => f.status === 'available').length;
    const maintenanceFacilities = COMPLETE_DATA.facilities.filter(f => f.status === 'maintenance').length;
    
    return `
        <div class="card">
            <h2 style="color: var(--secondary); margin-bottom: 1.5rem;">
                <span style="font-size: 1.8rem;">ğŸŒŒ</span> Dashboard Utama
                ${appState.isArchitect ? '<span style="margin-left: 10px; background: var(--architect); padding: 5px 10px; border-radius: 10px; font-size: 0.8rem;">ğŸ‘‘ ARCHITECT</span>' : ''}
            </h2>
            
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(0,212,255,0.1); border-radius: 15px;">
                <div style="color: var(--secondary); font-size: 1.2rem; font-weight: 600;" id="greetingText"></div>
                <div style="margin-top: 0.5rem; color: rgba(255,255,255,0.8);">
                    Sistem General Affairs SIF Al Fikri â€¢ v${CONFIG.version}
                </div>
            </div>
            
            <!-- System Status -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" onclick="showView('booking')">
                    <div style="font-size: 2.5rem; color: var(--secondary);">ğŸ›ï¸</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">${availableFacilities}</div>
                    <div style="font-size: 0.9rem;">Sarana Tersedia</div>
                    <div style="font-size: 0.7rem; color: var(--warning); margin-top: 0.3rem;">
                        ${maintenanceFacilities} dalam maintenance
                    </div>
                </div>
                <div class="stat-card" onclick="showView('booking')">
                    <div style="font-size: 2.5rem; color: #4CAF50;">ğŸ“…</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">${bookings.length}</div>
                    <div style="font-size: 0.9rem;">Total Bookings</div>
                </div>
                <div class="stat-card" onclick="showView('k3')">
                    <div style="font-size: 2.5rem; color: var(--warning);">âš ï¸</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">${k3Reports.length}</div>
                    <div style="font-size: 0.9rem;">Laporan K3</div>
                </div>
                <div class="stat-card" onclick="showView('inventory')">
                    <div style="font-size: 2.5rem; color: var(--accent);">ğŸ”§</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">${inventory.length}</div>
                    <div style="font-size: 0.9rem;">Item Inventory</div>
                </div>
            </div>
            
            <!-- Important Notes -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,152,0,0.1); border-radius: 10px; border-left: 4px solid var(--warning);">
                <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.5rem;">ğŸ“¢ Important Notes:</div>
                <div style="font-size: 0.85rem;">
                    â€¢ Jam booking: Senin-Kamis (07:30-16:00), Jumat (10:30-13:00)<br>
                    â€¢ Aula SMP & Serbaguna TIDAK BISA dibooking hari Jumat<br>
                    â€¢ Masjid dalam maintenance (tidak bisa digunakan)<br>
                    â€¢ Konfirmasi ke Pak Erwin: ${CONFIG.contactNumber}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: var(--secondary); margin-bottom: 1rem;">Quick Actions</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="showView('booking')" class="quick-action-btn" style="border-color: var(--secondary); color: var(--secondary);">
                        ğŸ“… Buat Booking Baru
                    </button>
                    <button onclick="showView('k3')" class="quick-action-btn" style="border-color: var(--warning); color: var(--warning);">
                        âš ï¸ Laporkan Masalah
                    </button>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div style="margin-top: 1.5rem;">
                <h3 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ“‹ Recent Activity</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${bookings.slice(-3).reverse().map(booking => `
                        <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-weight: 600;">${booking.facility}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                                ${booking.date} â€¢ ${booking.startTime} - ${booking.endTime}
                            </div>
                            <div style="font-size: 0.8rem; margin-top: 0.3rem;">
                                <span style="color: ${booking.status === 'approved' ? '#4CAF50' : 
                                                 booking.status === 'rejected' ? '#f44336' : '#FF9800'}">
                                    ${booking.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                    ${bookings.length === 0 ? `
                        <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                            Tidak ada activity
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <style>
            .stat-card {
                padding: 1.5rem; text-align: center; background: rgba(255,255,255,0.03); 
                border-radius: 15px; border: 1px solid rgba(0,212,255,0.1); cursor: pointer;
                transition: all 0.3s;
            }
            .stat-card:hover {
                transform: translateY(-5px); border-color: var(--secondary);
                box-shadow: 0 5px 15px rgba(0,212,255,0.1);
            }
            .quick-action-btn {
                padding: 1rem; background: rgba(255,255,255,0.05);
                border: 2px solid; border-radius: 10px; cursor: pointer;
                transition: all 0.3s; font-weight: 600;
            }
            .quick-action-btn:hover {
                transform: translateY(-3px); opacity: 0.9;
            }
        </style>
    `;
}

function renderBooking() {
    return `
        <div class="card">
            <div style="display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem;">
                <button onclick="showView('home')" class="back-btn">
                    â† Kembali
                </button>
                <div style="flex: 1; text-align: center;">
                    <div style="color: var(--secondary); font-weight: 700; font-size: 1.3rem;">ğŸ“… Smart Booking System</div>
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Kirim langsung ke WhatsApp Pak Erwin</div>
                </div>
            </div>
            
            <!-- Booking Rules Info -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,212,255,0.1); border-radius: 10px;">
                <div style="color: var(--secondary); font-weight: 600; margin-bottom: 0.5rem;">ğŸ“‹ Aturan Booking:</div>
                <div style="font-size: 0.85rem;">
                    â€¢ Normal: Senin-Kamis (07:30 - 16:00)<br>
                    â€¢ Jumat: (10:30 - 13:00) - Shalat Jumat<br>
                    â€¢ Tidak bisa booking: Aula SMP & Serbaguna (Jumat)<br>
                    â€¢ Maintenance: Masjid (tidak bisa digunakan)
                </div>
            </div>
            
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Nama Pemohon *</label>
                    <input type="text" class="form-input" placeholder="Masukkan nama lengkap..." id="bookingName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ No. WhatsApp *</label>
                    <input type="tel" class="form-input" placeholder="08xxxxxxxxxx" id="bookingPhone" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“§ Email (Opsional)</label>
                    <input type="email" class="form-input" placeholder="email@example.com" id="bookingEmail">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ« Unit *</label>
                    <select class="form-select" id="bookingUnit" required>
                        <option value="">Pilih unit...</option>
                        ${COMPLETE_DATA.units.map(unit => `
                            <option value="${unit.id}">${unit.name}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ›ï¸ Sarana yang Dibooking *</label>
                    <select class="form-select" id="bookingFacility" required onchange="updateFacilityInfo()">
                        <option value="">Pilih sarana...</option>
                        ${COMPLETE_DATA.facilities.filter(f => f.status === 'available').map(fac => `
                            <option value="${fac.id}" ${fac.status === 'maintenance' ? 'disabled' : ''}>
                                ${fac.name} ${fac.status === 'maintenance' ? '(MAINTENANCE)' : ''}
                            </option>
                        `).join('')}
                    </select>
                    <div id="facilityInfo" style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.7); display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“… Tanggal Booking *</label>
                    <input type="date" class="form-input" id="bookingDate" 
                           min="${new Date().toISOString().split('T')[0]}" 
                           onchange="updateTimeOptions()" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">â° Waktu Booking *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 0.5rem;">Waktu Mulai *</div>
                            <select class="form-select" id="bookingStartTime" required>
                                <option value="">Pilih waktu</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 0.5rem;">Waktu Selesai *</div>
                            <select class="form-select" id="bookingEndTime" required>
                                <option value="">Pilih waktu</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ Tujuan & Keterangan *</label>
                    <textarea class="form-textarea" id="bookingPurpose" 
                              placeholder="Jelaskan tujuan booking, acara, jumlah peserta, kebutuhan alat tambahan..." 
                              rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ‘¥ Perkiraan Jumlah Peserta *</label>
                    <input type="number" class="form-input" id="bookingParticipants" placeholder="0" min="1" required>
                </div>
                
                <!-- Equipment Needs -->
                <div class="form-group">
                    <label class="form-label">ğŸ”§ Kebutuhan Alat Tambahan (Opsional)</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.8rem; margin-top: 0.5rem;">
                        ${COMPLETE_DATA.equipment.map(item => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                                <input type="checkbox" value="${item.id}" style="transform: scale(1.2);">
                                ${item.name}
                            </label>
                        `).join('')}
                    </div>
                </div>
                
                <button type="button" class="btn" onclick="validateAndSubmitBooking()">
                    <span style="display: block; font-size: 1.1rem; margin-bottom: 0.3rem;">
                        ğŸš€ Submit Booking Request
                    </span>
                    <span style="font-size: 0.9rem; opacity: 0.9;">
                        Akan dikirim ke WhatsApp ${CONFIG.contactPerson}
                    </span>
                </button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,212,255,0.1); border-radius: 10px;">
                <div style="color: var(--secondary); font-weight: 600; margin-bottom: 0.5rem;">ğŸ’¡ Informasi:</div>
                <div style="font-size: 0.9rem;">
                    1. Booking akan diproses dalam 1x24 jam<br>
                    2. Konfirmasi melalui WhatsApp/Email<br>
                    3. Batalkan minimal 1 hari sebelumnya<br>
                    4. Pastikan data yang diisi benar<br>
                    5. Dokumentasikan penggunaan sarana
                </div>
            </div>
        </div>
        
        <style>
            .back-btn {
                background: rgba(0,212,255,0.1); border: 2px solid var(--secondary); 
                color: var(--secondary); padding: 0.7rem 1.2rem; border-radius: 10px; 
                cursor: pointer; font-weight: 600;
            }
            .back-btn:hover {
                background: rgba(0,212,255,0.2);
            }
        </style>
    `;
}

function renderK3() {
    return `
        <div class="card">
            <div style="display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem;">
                <button onclick="showView('home')" class="back-btn">
                    â† Kembali
                </button>
                <div style="flex: 1; text-align: center;">
                    <div style="color: var(--warning); font-weight: 700; font-size: 1.3rem;">âš ï¸ K3 Reporting System</div>
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Laporan cepat dengan foto - Sudah diperbaiki!</div>
                </div>
            </div>
            
            <form id="k3Form">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Nama Pelapor *</label>
                    <input type="text" class="form-input" placeholder="Nama lengkap pelapor..." id="k3Name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ No. WhatsApp *</label>
                    <input type="tel" class="form-input" placeholder="08xxxxxxxxxx" id="k3Phone" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">âš ï¸ Jenis Laporan *</label>
                    <select class="form-select" id="k3Type" required>
                        <option value="">Pilih jenis...</option>
                        ${COMPLETE_DATA.k3Types.map(type => `
                            <option value="${type.id}" style="color: ${type.color};">${type.name}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ Lokasi Kejadian *</label>
                    <select class="form-select" id="k3Location" required>
                        <option value="">Pilih lokasi...</option>
                        ${COMPLETE_DATA.k3Locations.map(loc => `
                            <option value="${loc}">${loc}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“¸ Foto Bukti (Sangat disarankan)</label>
                    <div onclick="openCameraModal()" 
                         style="width:100%; height:200px; background:rgba(0,0,0,0.2); 
                                border-radius:15px; display:flex; align-items:center; 
                                justify-content:center; cursor:pointer; border: 2px dashed rgba(0,212,255,0.3);">
                        ${appState.capturedPhoto ? 
                            `<img src="${appState.capturedPhoto}" style="width:100%; height:100%; object-fit:cover; border-radius:13px;">` :
                            `<div style="text-align:center; color:rgba(255,255,255,0.5);">
                                <div style="font-size:3rem; color:var(--secondary);">ğŸ“·</div>
                                <p>Klik untuk membuka kamera</p>
                                <p style="font-size:0.8rem; color:var(--warning); margin-top:0.5rem;">
                                    âš ï¸ Fitur kamera sudah diperbaiki!
                                </p>
                            </div>`
                        }
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ Deskripsi Lengkap *</label>
                    <textarea class="form-textarea" id="k3Description" 
                              placeholder="Jelaskan secara detail apa yang terjadi, kerusakan, bahaya, tingkat urgensi..." 
                              rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸš¨ Tingkat Urgensi</label>
                    <select class="form-select" id="k3Urgency">
                        <option value="low">Rendah (1-3 hari)</option>
                        <option value="medium" selected>Sedang (24 jam)</option>
                        <option value="high">Tinggi (4 jam)</option>
                        <option value="critical">Kritis (SEGERA)</option>
                    </select>
                </div>
                
                <button type="button" class="btn" onclick="submitK3Report()" 
                        style="background: linear-gradient(135deg, var(--warning), #FF9800);">
                    <span style="display: block; font-size: 1.1rem; margin-bottom: 0.3rem;">
                        ğŸš¨ Kirim Laporan K3
                    </span>
                    <span style="font-size: 0.9rem; opacity: 0.9;">
                        Akan dikirim ke WhatsApp Pak Erwin & Email Teknisi
                    </span>
                </button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,152,0,0.1); border-radius: 10px;">
                <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.5rem;">ğŸ“ Emergency Contact:</div>
                <div style="font-size: 0.9rem;">
                    â€¢ Pak Erwin: 0888-6183-954<br>
                    â€¢ Security: 021-1234567<br>
                    â€¢ Maintenance: 021-7654321<br>
                    â€¢ Email Teknisi: ${CONFIG.adminEmail}
                </div>
            </div>
        </div>
    `;
}

function renderInventory() {
    const vaultAccess = appState.isArchitect || appState.isAdmin;
    
    return `
        <div class="card">
            <div style="display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem;">
                <button onclick="showView('home')" class="back-btn">
                    â† Kembali
                </button>
                <div style="flex: 1; text-align: center;">
                    <div style="color: var(--accent); font-weight: 700; font-size: 1.3rem;">ğŸ”§ Inventory Management</div>
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Data peralatan sekolah v4.2</div>
                </div>
                ${vaultAccess ? `
                    <button onclick="openVault()" class="back-btn" style="background: var(--quantum); border-color: var(--quantum);">
                        ğŸ”“ Vault
                    </button>
                ` : ''}
            </div>
            
            <!-- Inventory List -->
            <div id="inventoryList" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;">
                Loading inventory...
            </div>
            
            <!-- Statistics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: rgba(0,212,255,0.1); border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; color: var(--secondary);" id="totalItems">0</div>
                    <div style="font-size: 0.9rem;">Total Items</div>
                </div>
                <div style="padding: 1rem; background: rgba(76,175,80,0.1); border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; color: #4CAF50;" id="availableItems">0</div>
                    <div style="font-size: 0.9rem;">Available</div>
                </div>
                <div style="padding: 1rem; background: rgba(255,152,0,0.1); border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; color: var(--warning);" id="inUseItems">0</div>
                    <div style="font-size: 0.9rem;">In Use</div>
                </div>
                <div style="padding: 1rem; background: rgba(156,39,176,0.1); border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; color: var(--purple);" id="categories">${new Set(COMPLETE_DATA.equipment.map(e => e.category)).size}</div>
                    <div style="font-size: 0.9rem;">Categories</div>
                </div>
            </div>
            
            <!-- Sync Section -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,212,255,0.05); border-radius: 10px;">
                <div style="color: var(--secondary); font-weight: 600; margin-bottom: 0.5rem;">ğŸ”„ Sync Status:</div>
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);" id="syncStatus">
                    Local storage: Active â€¢ Cloud: ${supabaseClient ? 'Connected' : 'Offline'}
                </div>
                ${supabaseClient ? `
                    <button onclick="syncToCloud()" style="margin-top: 0.8rem; padding: 0.7rem 1.5rem; background: rgba(0,212,255,0.2); 
                            border: 1px solid var(--secondary); color: var(--secondary); border-radius: 8px; cursor: pointer;">
                        ğŸ”„ Sync to Cloud
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

function renderAdmin() {
    if (!appState.isAdmin && !appState.isArchitect) {
        return `
            <div class="card">
                <div style="display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem;">
                    <button onclick="showView('home')" class="back-btn">
                        â† Kembali
                    </button>
                    <div style="flex: 1; text-align: center;">
                        <div style="color: var(--purple); font-weight: 700; font-size: 1.3rem;">ğŸ” Admin Login</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Hanya untuk staff berwenang</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <div style="width: 100px; height: 100px; background: rgba(0,212,255,0.2); border-radius: 50%; 
                         display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; 
                         font-size: 3rem; color: var(--secondary);">
                        ğŸ”
                    </div>
                    <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Authentication Required</h3>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Masukkan kredensial untuk akses admin
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Username / Email</label>
                    <input type="text" class="form-input" placeholder="Masukkan username atau email..." id="adminUsername">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ”‘ Password</label>
                    <input type="password" class="form-input" placeholder="Masukkan password..." id="adminPassword">
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="adminLogin()" 
                            style="flex: 1; background: linear-gradient(135deg, var(--purple), #9c27b0);">
                        ğŸ”“ Login sebagai Admin
                    </button>
                    <button class="btn" onclick="architectLogin()" 
                            style="flex: 1; background: linear-gradient(135deg, var(--quantum), #7B1FA2);">
                        ğŸ‘‘ Architect Access
                    </button>
                </div>
                
                <!-- Demo Credentials -->
                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255,215,0,0.1); border-radius: 12px;">
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); text-align: center;">
                        <strong style="color: var(--warning);">Demo Credentials:</strong><br>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="background: rgba(0,212,255,0.1); padding: 0.7rem; border-radius: 8px;">
                                <div style="color: var(--secondary); font-weight: 600;">Admin</div>
                                <div style="font-size: 0.8rem;">Username: admin<br>Password: admin123</div>
                            </div>
                            <div style="background: rgba(156,39,176,0.1); padding: 0.7rem; border-radius: 8px;">
                                <div style="color: var(--purple); font-weight: 600;">Architect</div>
                                <div style="font-size: 0.8rem;">Code: 418626</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const k3Reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
        const openK3 = k3Reports.filter(r => r.status === 'open').length;
        
        return `
            <div class="card">
                <div style="display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem;">
                    <button onclick="showView('home')" class="back-btn">
                        â† Kembali
                    </button>
                    <div style="flex: 1; text-align: center;">
                        <div style="color: var(--purple); font-weight: 700; font-size: 1.3rem;">
                            ${appState.isArchitect ? 'ğŸ‘‘ ARCHITECT DASHBOARD' : 'ğŸ‘‘ ADMIN DASHBOARD'}
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                            Welcome, ${appState.isArchitect ? 'Architect' : 'Admin'}!
                        </div>
                    </div>
                    <button onclick="logoutAdmin()" class="back-btn" style="background: rgba(255,86,86,0.1); border-color: var(--danger); color: var(--danger);">
                        ğŸšª Logout
                    </button>
                </div>
                
                <!-- Admin Menu -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1.2rem; margin-bottom: 2rem;">
                    <button onclick="viewBookings()" class="admin-menu-btn">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“…</div>
                        <div>View Bookings</div>
                        <div style="font-size: 0.8rem; color: var(--secondary);">${bookings.length} total</div>
                    </button>
                    <button onclick="viewK3Reports()" class="admin-menu-btn">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">âš ï¸</div>
                        <div>K3 Reports</div>
                        <div style="font-size: 0.8rem; color: var(--warning);">${openK3} open</div>
                    </button>
                    <button onclick="viewInventory()" class="admin-menu-btn">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”§</div>
                        <div>Inventory</div>
                        <div style="font-size: 0.8rem; color: var(--accent);">${COMPLETE_DATA.equipment.length} items</div>
                    </button>
                    ${appState.isArchitect ? `
                        <button onclick="openArchitectTools()" class="admin-menu-btn" style="border-color: var(--quantum);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">âš¡</div>
                            <div>Architect Tools</div>
                            <div style="font-size: 0.8rem; color: var(--quantum);">Advanced</div>
                        </button>
                    ` : ''}
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1rem; background: rgba(0,212,255,0.1); border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.2rem; color: var(--secondary;">${bookings.length}</div>
                        <div style="font-size: 0.8rem;">Total Bookings</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(255,152,0,0.1); border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.2rem; color: var(--warning);">${openK3}</div>
                        <div style="font-size: 0.8rem;">Open K3</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(76,175,80,0.1); border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.2rem; color: #4CAF50;">${COMPLETE_DATA.equipment.length}</div>
                        <div style="font-size: 0.8rem;">Inventory Items</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(156,39,176,0.1); border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.2rem; color: var(--purple);">${COMPLETE_DATA.facilities.length}</div>
                        <div style="font-size: 0.8rem;">Facilities</div>
                    </div>
                </div>
                
                <!-- System Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <button onclick="exportData()" style="padding: 1rem; background: rgba(0,212,255,0.1); 
                           border: 2px solid var(--secondary); color: var(--secondary); border-radius: 10px;">
                        ğŸ’¾ Export Data
                    </button>
                    <button onclick="importData()" style="padding: 1rem; background: rgba(255,193,7,0.1); 
                           border: 2px solid var(--warning); color: var(--warning); border-radius: 10px;">
                        ğŸ“¥ Import Data
                    </button>
                    ${appState.isArchitect ? `
                        <button onclick="systemReset()" style="padding: 1rem; background: rgba(244,67,54,0.1); 
                               border: 2px solid var(--danger); color: var(--danger); border-radius: 10px;">
                            ğŸ”„ System Reset
                        </button>
                    ` : ''}
                </div>
                
                <!-- System Info -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="color: var(--secondary); font-weight: 600; margin-bottom: 0.5rem;">ğŸ–¥ï¸ System Info:</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                        â€¢ Version: ${CONFIG.version}<br>
                        â€¢ Supabase: ${supabaseClient ? 'Connected' : 'Offline'}<br>
                        â€¢ Storage: ${localStorage.length} items<br>
                        â€¢ Last Sync: ${new Date().toLocaleTimeString('id-ID')}<br>
                        â€¢ Access Level: ${appState.isArchitect ? 'Architect' : appState.isAdmin ? 'Admin' : 'User'}
                    </div>
                </div>
            </div>
            
            <style>
                .admin-menu-btn {
                    padding: 1.5rem 0.5rem; background: rgba(255,255,255,0.03); 
                    border: 2px solid rgba(0,212,255,0.1); color: white; 
                    border-radius: 15px; cursor: pointer; transition: all 0.3s;
                    display: flex; flex-direction: column; align-items: center;
                }
                .admin-menu-btn:hover {
                    transform: translateY(-5px); border-color: var(--purple);
                    background: rgba(156,39,176,0.1);
                }
            </style>
        `;
    }
}

// ==================== UTILITY FUNCTIONS ====================
function updateGreeting() {
    const now = new Date();
    const hour = now.getHours();
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const day = days[now.getDay()];
    
    let greeting = '';
    if (hour >= 4 && hour < 10) greeting = 'ğŸŒ„ Subhanallah, pagi penuh berkah';
    else if (hour >= 10 && hour < 15) greeting = 'â˜€ï¸ Allahu Akbar, siang yang produktif';
    else if (hour >= 15 && hour < 18) greeting = 'ğŸŒ… Masya Allah, sore penuh kedamaian';
    else greeting = 'ğŸŒ™ Allahumma barik, malam yang penuh hikmah';
    
    const greetingEl = document.getElementById('greeting');
    const greetingTextEl = document.getElementById('greetingText');
    
    if (greetingEl) greetingEl.textContent = `${greeting} â€¢ ${day}`;
    if (greetingTextEl) greetingTextEl.textContent = `${greeting} â€¢ ${day}`;
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    const colors = {
        'success': '#4CAF50', 
        'error': '#f44336', 
        'warning': '#FF9800', 
        'info': '#2196f3',
        'quantum': '#9C27B0'
    };
    
    const icons = {
        'success': 'âœ…', 
        'error': 'âŒ', 
        'warning': 'âš ï¸', 
        'info': 'â„¹ï¸',
        'quantum': 'ğŸŒŒ'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.innerHTML = `
        <div style="font-size: 1.5rem; color: white;">
            ${icons[type] || 'â„¹ï¸'}
        </div>
        <div style="flex: 1;">${message}</div>
        <button onclick="this.parentElement.style.display='none'" 
                style="background:transparent; border:none; color:white; font-size:1.2rem; cursor:pointer;">
            Ã—
        </button>
    `;
    notification.style.display = 'flex';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// ==================== BOOKING FUNCTIONS ====================
function loadFacilityOptions() {
    const facilitySelect = document.getElementById('bookingFacility');
    if (!facilitySelect) return;
    
    facilitySelect.innerHTML = '<option value="">Pilih sarana...</option>' +
        COMPLETE_DATA.facilities.map(fac => `
            <option value="${fac.id}" ${fac.status === 'maintenance' ? 'disabled' : ''}>
                ${fac.name} ${fac.status === 'maintenance' ? '(MAINTENANCE)' : ''}
            </option>
        `).join('');
}

function updateFacilityInfo() {
    const facilityId = document.getElementById('bookingFacility').value;
    const infoDiv = document.getElementById('facilityInfo');
    
    if (!facilityId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const facility = COMPLETE_DATA.facilities.find(f => f.id === facilityId);
    if (facility) {
        infoDiv.innerHTML = `
            <div style="padding: 0.5rem; background: rgba(0,212,255,0.1); border-radius: 5px;">
                <strong>${facility.name}:</strong> Kapasitas ${facility.capacity} orang<br>
                <strong>Equipment:</strong> ${facility.equipment.length > 0 ? facility.equipment.join(', ') : 'Tidak ada'}<br>
                <strong>Status:</strong> <span style="color: ${facility.status === 'available' ? '#4CAF50' : '#FF9800'}">
                    ${facility.status === 'available' ? 'Tersedia' : 'Maintenance'}
                </span>
            </div>
        `;
        infoDiv.style.display = 'block';
    }
}

function updateTimeOptions() {
    const dateInput = document.getElementById('bookingDate').value;
    if (!dateInput) return;
    
    const date = new Date(dateInput);
    const dayName = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][date.getDay()];
    const isFriday = dayName === 'Jumat';
    
    const startSelect = document.getElementById('bookingStartTime');
    const endSelect = document.getElementById('bookingEndTime');
    
    // Clear existing options
    startSelect.innerHTML = '<option value="">Pilih waktu</option>';
    endSelect.innerHTML = '<option value="">Pilih waktu</option>';
    
    // Define time slots based on day
    let timeSlots = [];
    if (isFriday) {
        // Friday slots: 10:30, 11:00, 11:30, 12:00, 12:30
        for (let hour = 10; hour <= 12; hour++) {
            for (let minute = 0; minute <= 30; minute += 30) {
                if (hour === 10 && minute === 0) continue; // Skip 10:00 on Friday
                if (hour === 12 && minute === 30) continue; // Last slot is 12:30
                const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeSlots.push(time);
            }
        }
    } else {
        // Normal days: 07:30 to 15:30 in 30-minute increments
        for (let hour = 7; hour <= 15; hour++) {
            for (let minute = 0; minute <= 30; minute += 30) {
                if (hour === 7 && minute === 0) continue; // Start at 07:30
                if (hour === 15 && minute === 30) continue; // End at 15:00
                const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeSlots.push(time);
            }
        }
    }
    
    // Populate start time options
    timeSlots.forEach(time => {
        startSelect.innerHTML += `<option value="${time}">${time}</option>`;
    });
    
    // When start time changes, update end time options
    startSelect.onchange = function() {
        const startTime = this.value;
        if (!startTime) return;
        
        const startIndex = timeSlots.indexOf(startTime);
        endSelect.innerHTML = '<option value="">Pilih waktu</option>';
        
        // Only show times after start time
        for (let i = startIndex + 1; i < timeSlots.length; i++) {
            endSelect.innerHTML += `<option value="${timeSlots[i]}">${timeSlots[i]}</option>`;
        }
    };
    
    // Show day info
    const dayInfo = isFriday ? 
        `ğŸ“… <strong>Hari Jumat:</strong> Booking hanya 10:30-13:00` :
        `ğŸ“… <strong>${dayName}:</strong> Booking 07:30-16:00`;
    
    if (document.getElementById('dayInfo')) {
        document.getElementById('dayInfo').innerHTML = dayInfo;
    }
}

function validateAndSubmitBooking() {
    const name = document.getElementById('bookingName').value.trim();
    const phone = document.getElementById('bookingPhone').value.trim();
    const email = document.getElementById('bookingEmail').value.trim();
    const unit = document.getElementById('bookingUnit').value;
    const facilityId = document.getElementById('bookingFacility').value;
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('bookingStartTime').value;
    const endTime = document.getElementById('bookingEndTime').value;
    const purpose = document.getElementById('bookingPurpose').value.trim();
    const participants = document.getElementById('bookingParticipants').value;
    
    // Validation
    if (!name || !phone || !unit || !facilityId || !date || !startTime || !endTime || !purpose || !participants) {
        showNotification('Harap isi semua field yang wajib!', 'error');
        return;
    }
    
    // Validate phone
    const phoneRegex = /^[0-9]{10,13}$/;
    if (!phoneRegex.test(phone.replace(/\D/g, ''))) {
        showNotification('Nomor WhatsApp tidak valid', 'error');
        return;
    }
    
    // Validate participants
    if (participants < 1) {
        showNotification('Jumlah peserta minimal 1', 'error');
        return;
    }
    
    // Get facility
    const facility = COMPLETE_DATA.facilities.find(f => f.id === facilityId);
    if (!facility) {
        showNotification('Sarana tidak valid', 'error');
        return;
    }
    
    // Check if facility is available
    if (facility.status === 'maintenance') {
        showNotification(`Sarana ${facility.name} sedang dalam maintenance!`, 'error');
        return;
    }
    
    // Check Friday restrictions
    const bookingDate = new Date(date);
    const dayName = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][bookingDate.getDay()];
    const isFriday = dayName === 'Jumat';
    
    if (isFriday && CONFIG.bookingRules.blockedFacilitiesFriday.includes(facilityId)) {
        showNotification(`Sarana ${facility.name} tidak bisa dibooking hari Jumat karena digunakan untuk Shalat Jumat`, 'error');
        return;
    }
    
    // Check time validity for the day
    if (isFriday) {
        if (startTime < '10:30' || endTime > '13:00') {
            showNotification('Hari Jumat booking hanya bisa 10:30-13:00', 'error');
            return;
        }
    } else {
        if (startTime < '07:30' || endTime > '16:00') {
            showNotification('Jam booking hanya 07:30-16:00', 'error');
            return;
        }
    }
    
    // Get selected equipment
    const equipmentNeeds = [];
    document.querySelectorAll('#bookingForm input[type="checkbox"]:checked').forEach(cb => {
        equipmentNeeds.push(cb.value);
    });
    
    // Create booking object
    const booking = {
        id: 'BOOK-' + Date.now().toString().slice(-8),
        name: name,
        phone: phone,
        email: email || null,
        unit: unit,
        facility: facility.name,
        facilityId: facilityId,
        date: date,
        day: dayName,
        startTime: startTime,
        endTime: endTime,
        purpose: purpose,
        participants: parseInt(participants),
        equipmentNeeds: equipmentNeeds,
        status: 'pending',
        submittedAt: new Date().toISOString(),
        rulesApplied: {
            isFriday: isFriday,
            timeRestricted: true
        }
    };
    
    // Save to localStorage
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    bookings.push(booking);
    localStorage.setItem('bookings', JSON.stringify(bookings));
    
    // Generate WhatsApp message
    const whatsappMessage = generateBookingWhatsAppMessage(booking, facility);
    
    // Show success
    showNotification('âœ… Booking submitted! Siap kirim ke WhatsApp', 'success');
    
    // Open WhatsApp
    setTimeout(() => {
        sendToWhatsApp(whatsappMessage);
    }, 1500);
    
    // Reset form
    setTimeout(() => {
        document.getElementById('bookingForm').reset();
        showView('booking');
    }, 2000);
}

function generateBookingWhatsAppMessage(booking, facility) {
    const unitName = COMPLETE_DATA.units.find(u => u.id === booking.unit)?.name || booking.unit;
    const equipmentList = booking.equipmentNeeds.map(eid => {
        const item = COMPLETE_DATA.equipment.find(i => i.id === eid);
        return item ? item.name : eid;
    }).join(', ') || 'Tidak ada';
    
    return `ğŸ“‹ *BOOKING SARANA - ${CONFIG.schoolName}*

ğŸ‘¤ *Pemohon:* ${booking.name}
ğŸ“ *WhatsApp:* ${booking.phone}
${booking.email ? `ğŸ“§ *Email:* ${booking.email}\n` : ''}ğŸ« *Unit:* ${unitName}

ğŸ›ï¸ *Sarana:* ${booking.facility}
ğŸ“… *Tanggal:* ${booking.date} (${booking.day})
â° *Waktu:* ${booking.startTime} - ${booking.endTime}
ğŸ‘¥ *Jumlah Peserta:* ${booking.participants}

ğŸ“ *Keperluan/Tujuan:*
${booking.purpose}

ğŸ”§ *Kebutuhan Alat Tambahan:*
${equipmentList}

ğŸ“Š *Info Sarana:*
â€¢ Kapasitas: ${facility.capacity} orang
â€¢ Equipment include: ${facility.equipment.join(', ') || 'Tidak ada'}
â€¢ Status: ${facility.status === 'available' ? 'âœ… Tersedia' : 'âš ï¸ Maintenance'}

ğŸ†” *ID Booking:* ${booking.id}
â³ *Diajukan:* ${new Date(booking.submittedAt).toLocaleString('id-ID')}
ğŸ“‹ *Status:* Menunggu konfirmasi

ğŸ“ *Konfirmasi ke:* ${CONFIG.contactPerson} (${CONFIG.contactNumber})
ğŸ“§ *Email:* ${CONFIG.adminEmail}

*CATATAN PENTING:*
${booking.day === 'Jumat' ? 'â€¢ Hari Jumat: Waktu terbatas 10:30-13:00\n' : ''}${CONFIG.bookingRules.blockedFacilitiesFriday.includes(booking.facilityId) && booking.day === 'Jumat' ? 'â€¢ Sarana ini tidak bisa digunakan hari Jumat (Shalat Jumat)\n' : ''}â€¢ Masjid sedang maintenance (tidak bisa digunakan)`;
}

// ==================== K3 FUNCTIONS ====================
function openCameraModal() {
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'flex';
    
    // Start camera
    startCamera();
}

function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            const video = document.getElementById('cameraVideo');
            appState.cameraStream = stream;
            video.srcObject = stream;
        })
        .catch(error => {
            console.error('Camera error:', error);
            showNotification('Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.', 'error');
            closeCamera();
        });
}

function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw current video frame to canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Add watermark
    context.font = 'bold 24px Arial';
    context.fillStyle = 'rgba(0, 212, 255, 0.8)';
    context.fillText(CONFIG.schoolName, 20, 40);
    context.font = '18px Arial';
    context.fillText('K3 Report - ' + new Date().toLocaleDateString('id-ID'), 20, canvas.height - 20);
    
    // Convert to data URL
    appState.capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
    
    // Stop camera
    if (appState.cameraStream) {
        appState.cameraStream.getTracks().forEach(track => track.stop());
    }
    
    closeCamera();
    showNotification('âœ… Foto berhasil diambil!', 'success');
    
    // Update K3 view
    if (appState.currentView === 'k3') {
        showView('k3');
    }
}

function closeCamera() {
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'none';
    
    // Stop camera if still running
    if (appState.cameraStream) {
        appState.cameraStream.getTracks().forEach(track => track.stop());
        appState.cameraStream = null;
    }
}

function submitK3Report() {
    const reporter = document.getElementById('k3Name').value.trim();
    const phone = document.getElementById('k3Phone').value.trim();
    const typeId = document.getElementById('k3Type').value;
    const location = document.getElementById('k3Location').value;
    const description = document.getElementById('k3Description').value.trim();
    const urgency = document.getElementById('k3Urgency').value;
    
    // Validation
    if (!reporter || !phone || !typeId || !location || !description) {
        showNotification('Harap isi semua field yang wajib!', 'error');
        return;
    }
    
    // Validate phone
    const phoneRegex = /^[0-9]{10,13}$/;
    if (!phoneRegex.test(phone.replace(/\D/g, ''))) {
        showNotification('Nomor WhatsApp tidak valid', 'error');
        return;
    }
    
    // Get K3 type
    const k3Type = COMPLETE_DATA.k3Types.find(t => t.id === typeId);
    
    // Create report object
    const report = {
        id: 'K3-' + Date.now().toString().slice(-8),
        reporter: reporter,
        phone: phone,
        type: typeId,
        typeName: k3Type ? k3Type.name : typeId,
        location: location,
        description: description,
        urgency: urgency,
        photo: appState.capturedPhoto,
        status: 'open',
        assignedTo: k3Type ? k3Type.team : 'General',
        submittedAt: new Date().toISOString(),
        priority: k3Type ? k3Type.priority : 'medium'
    };
    
    // Save to localStorage
    const reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
    reports.push(report);
    localStorage.setItem('k3_reports', JSON.stringify(reports));
    
    // Save to Supabase if connected
    if (supabaseClient) {
        saveToSupabase('k3_reports', report);
    }
    
    // Generate WhatsApp message
    const whatsappMessage = generateK3WhatsAppMessage(report);
    
    // Show success
    showNotification('âœ… Laporan K3 submitted! Mengirim ke WhatsApp...', 'success');
    
    // Open WhatsApp
    setTimeout(() => {
        sendToWhatsApp(whatsappMessage);
    }, 1500);
    
    // Reset photo
    appState.capturedPhoto = null;
    
    // Reset form
    setTimeout(() => {
        document.getElementById('k3Form').reset();
    }, 2000);
}

function generateK3WhatsAppMessage(report) {
    const urgencyText = {
        'critical': 'ğŸš¨ KRITIS (SEGERA - <1 jam)',
        'high': 'ğŸ”´ TINGGI (4 jam)',
        'medium': 'ğŸŸ¡ SEDANG (24 jam)',
        'low': 'ğŸŸ¢ RENDAH (1-3 hari)'
    }[report.urgency] || 'ğŸŸ¡ SEDANG';
    
    return `âš ï¸ *LAPORAN K3 - ${CONFIG.schoolName}*

ğŸ‘¤ *Pelapor:* ${report.reporter}
ğŸ“ *WhatsApp:* ${report.phone}
ğŸ“ *Lokasi:* ${report.location}
ğŸ”§ *Jenis:* ${report.typeName}
ğŸš¨ *Urgensi:* ${urgencyText}
ğŸ‘¥ *Assigned to:* ${report.assignedTo}

ğŸ“ *Deskripsi Masalah:*
${report.description}

${report.photo ? 'ğŸ“¸ *Foto bukti terlampir*' : 'ğŸ“· *Tidak ada foto bukti*'}

ğŸ†” *ID Laporan:* ${report.id}
â° *Dilaporkan:* ${new Date(report.submittedAt).toLocaleString('id-ID')}
ğŸ“‹ *Status:* ${report.status === 'open' ? 'ğŸŸ¡ Open' : 'âœ… Closed'}
â­ *Priority:* ${report.priority}

ğŸš¨ *RESPONSE TIME TARGET:* ${report.urgency === 'critical' ? 'SEGERA (<1 jam)' : 
  report.urgency === 'high' ? '4 jam' : 
  report.urgency === 'medium' ? '24 jam' : '3 hari'}

ğŸ“ *Contact:* ${CONFIG.contactPerson} (${CONFIG.contactNumber})
ğŸ“§ *Email Teknisi:* ${CONFIG.adminEmail}

*TINDAKAN:*
1. Verifikasi laporan
2. Assign ke tim terkait
3. Update status di DREAM OS
4. Konfirmasi ke pelapor`;
}

// ==================== INVENTORY FUNCTIONS ====================
function loadInventory() {
    const inventory = JSON.parse(localStorage.getItem('inventory') || JSON.stringify(COMPLETE_DATA.equipment));
    const inventoryList = document.getElementById('inventoryList');
    
    if (!inventoryList) return;
    
    if (inventory.length === 0) {
        inventoryList.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                Tidak ada data inventory
            </div>
        `;
        return;
    }
    
    inventoryList.innerHTML = inventory.map(item => `
        <div style="display: flex; align-items: center; padding: 1rem; 
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                    background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 0.5rem;">
            <div style="margin-right: 1rem; font-size: 1.5rem;">
                ${getInventoryIcon(item.name)}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${item.name}</div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                    ID: ${item.id} â€¢ Category: ${item.category || 'General'}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; color: ${item.available > 0 ? '#4CAF50' : '#f44336'}">
                    ${item.available}/${item.quantity}
                </div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                    Available
                </div>
            </div>
        </div>
    `).join('');
    
    // Update statistics
    updateInventoryStats(inventory);
}

function getInventoryIcon(name) {
    if (name.includes('Sound')) return 'ğŸ”Š';
    if (name.includes('Projector') || name.includes('projektor')) return 'ğŸ“½ï¸';
    if (name.includes('Mic')) return 'ğŸ¤';
    if (name.includes('Kursi')) return 'ğŸª‘';
    if (name.includes('Meja')) return 'ğŸ›‹ï¸';
    if (name.includes('Kabel')) return 'ğŸ”Œ';
    return 'ğŸ“¦';
}

function updateInventoryStats(inventory) {
    const totalItems = inventory.length;
    const availableItems = inventory.reduce((sum, item) => sum + item.available, 0);
    const totalQuantity = inventory.reduce((sum, item) => sum + item.quantity, 0);
    const inUseItems = totalQuantity - availableItems;
    
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('availableItems').textContent = availableItems;
    document.getElementById('inUseItems').textContent = inUseItems;
}

function openVault() {
    const password = prompt('ğŸ” Enter Vault Password (Inventory):');
    if (password === PASSWORD_SYSTEM.vaultInventory) {
        showNotification('ğŸ”“ Vault Inventory unlocked!', 'success');
        // Add vault functionality here
    } else if (password) {
        showNotification('âŒ Invalid vault password', 'error');
    }
}

// ==================== ADMIN FUNCTIONS ====================
function adminLogin() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    
    if (!username || !password) {
        showNotification('Harap isi username dan password', 'warning');
        return;
    }
    
    // Check system passwords
    if (username === 'admin' && password === PASSWORD_SYSTEM.admin) {
        appState.isAdmin = true;
        showNotification(`âœ… Welcome, Admin!`, 'success');
        showView('admin');
        return;
    }
    
    // Check local storage users
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => 
        (u.username === username || u.email === username) && 
        u.password === password
    );
    
    if (user) {
        appState.isAdmin = user.role === 'admin' || user.role === 'superadmin';
        showNotification(`âœ… Welcome, ${user.name}!`, 'success');
        showView('admin');
    } else {
        showNotification('âŒ Username atau password salah', 'error');
    }
}

function architectLogin() {
    const code = prompt('ğŸ‘‘ Enter Architect Code:');
    if (code === PASSWORD_SYSTEM.architect) {
        unlockArchitectMode();
    } else if (code) {
        showNotification('âŒ Invalid architect code', 'error');
    }
}

function logoutAdmin() {
    appState.isAdmin = false;
    appState.isArchitect = false;
    showNotification('ğŸ‘‹ Logged out successfully', 'info');
    showView('admin');
}

function viewBookings() {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    
    const content = `
        <div class="card">
            <h3 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ“… All Bookings (${bookings.length})</h3>
            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                <button onclick="filterBookings('all')" style="padding: 0.5rem 1rem; background: var(--secondary); border: none; border-radius: 5px; color: white;">All</button>
                <button onclick="filterBookings('pending')" style="padding: 0.5rem 1rem; background: #FF9800; border: none; border-radius: 5px; color: white;">Pending</button>
                <button onclick="filterBookings('approved')" style="padding: 0.5rem 1rem; background: #4CAF50; border: none; border-radius: 5px; color: white;">Approved</button>
                <button onclick="filterBookings('rejected')" style="padding: 0.5rem 1rem; background: #f44336; border: none; border-radius: 5px; color: white;">Rejected</button>
            </div>
            <div id="bookingsList" style="max-height: 400px; overflow-y: auto;">
                ${renderBookingsList(bookings)}
            </div>
        </div>
    `;
    
    document.getElementById('content').innerHTML = content;
}

function renderBookingsList(bookings) {
    if (bookings.length === 0) {
        return `<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No bookings found</div>`;
    }
    
    return bookings.map(booking => `
        <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="font-weight: 600; font-size: 1.1rem;">${booking.facility}</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.3rem;">
                        ${booking.date} â€¢ ${booking.startTime} - ${booking.endTime}<br>
                        By: ${booking.name} (${booking.phone}) â€¢ ${booking.unit}
                    </div>
                </div>
                <div style="text-align: right;">
                    <span style="color: ${booking.status === 'pending' ? '#FF9800' : 
                                     booking.status === 'approved' ? '#4CAF50' : '#f44336'}; 
                           font-size: 0.8rem; font-weight: bold;">
                        ${booking.status.toUpperCase()}
                    </span>
                    ${appState.isAdmin ? `
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.3rem;">
                            <button onclick="updateBookingStatus('${booking.id}', 'approved')" style="padding: 0.3rem 0.6rem; background: #4CAF50; border: none; border-radius: 3px; color: white; font-size: 0.7rem;">Approve</button>
                            <button onclick="updateBookingStatus('${booking.id}', 'rejected')" style="padding: 0.3rem 0.6rem; background: #f44336; border: none; border-radius: 3px; color: white; font-size: 0.7rem;">Reject</button>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                <strong>Tujuan:</strong> ${booking.purpose.substring(0, 100)}${booking.purpose.length > 100 ? '...' : ''}
            </div>
            ${booking.equipmentNeeds && booking.equipmentNeeds.length > 0 ? `
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary);">
                    <strong>Equipment:</strong> ${booking.equipmentNeeds.join(', ')}
                </div>
            ` : ''}
        </div>
    `).join('');
}

function filterBookings(filter) {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    let filtered = bookings;
    
    if (filter !== 'all') {
        filtered = bookings.filter(b => b.status === filter);
    }
    
    document.getElementById('bookingsList').innerHTML = renderBookingsList(filtered);
}

function updateBookingStatus(bookingId, status) {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const bookingIndex = bookings.findIndex(b => b.id === bookingId);
    
    if (bookingIndex !== -1) {
        bookings[bookingIndex].status = status;
        bookings[bookingIndex].processedAt = new Date().toISOString();
        localStorage.setItem('bookings', JSON.stringify(bookings));
        
        showNotification(`âœ… Booking ${status} successfully!`, 'success');
        viewBookings();
    }
}

function viewK3Reports() {
    const reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
    
    const content = `
        <div class="card">
            <h3 style="color: var(--warning); margin-bottom: 1rem;">âš ï¸ K3 Reports (${reports.length})</h3>
            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                <button onclick="filterK3('all')" style="padding: 0.5rem 1rem; background: var(--warning); border: none; border-radius: 5px; color: white;">All</button>
                <button onclick="filterK3('open')" style="padding: 0.5rem 1rem; background: #f44336; border: none; border-radius: 5px; color: white;">Open</button>
                <button onclick="filterK3('in_progress')" style="padding: 0.5rem 1rem; background: #FF9800; border: none; border-radius: 5px; color: white;">In Progress</button>
                <button onclick="filterK3('closed')" style="padding: 0.5rem 1rem; background: #4CAF50; border: none; border-radius: 5px; color: white;">Closed</button>
            </div>
            <div id="k3List" style="max-height: 400px; overflow-y: auto;">
                ${renderK3List(reports)}
            </div>
        </div>
    `;
    
    document.getElementById('content').innerHTML = content;
}

function renderK3List(reports) {
    if (reports.length === 0) {
        return `<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No K3 reports found</div>`;
    }
    
    return reports.map(report => `
        <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="font-weight: 600; font-size: 1.1rem; color: ${COMPLETE_DATA.k3Types.find(t => t.id === report.type)?.color || '#FFFFFF'}">
                        ${report.typeName}
                    </div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.3rem;">
                        ${report.location} â€¢ ${new Date(report.submittedAt).toLocaleDateString('id-ID')}<br>
                        By: ${report.reporter} (${report.phone}) â€¢ Urgency: ${report.urgency}
                    </div>
                </div>
                <div style="text-align: right;">
                    <span style="color: ${report.status === 'open' ? '#f44336' : 
                                     report.status === 'in_progress' ? '#FF9800' : '#4CAF50'}; 
                           font-size: 0.8rem; font-weight: bold;">
                        ${report.status.toUpperCase()}
                    </span>
                    ${appState.isAdmin ? `
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.3rem;">
                            <button onclick="updateK3Status('${report.id}', 'in_progress')" style="padding: 0.3rem 0.6rem; background: #FF9800; border: none; border-radius: 3px; color: white; font-size: 0.7rem;">In Progress</button>
                            <button onclick="updateK3Status('${report.id}', 'closed')" style="padding: 0.3rem 0.6rem; background: #4CAF50; border: none; border-radius: 3px; color: white; font-size: 0.7rem;">Close</button>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                <strong>Deskripsi:</strong> ${report.description.substring(0, 150)}${report.description.length > 150 ? '...' : ''}
            </div>
            ${report.photo ? `
                <div style="margin-top: 0.5rem;">
                    <img src="${report.photo}" style="max-width: 100px; max-height: 100px; border-radius: 5px; cursor: pointer;" 
                         onclick="this.style.maxWidth='100%'; this.style.maxHeight='none';">
                </div>
            ` : ''}
        </div>
    `).join('');
}

function filterK3(filter) {
    const reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
    let filtered = reports;
    
    if (filter !== 'all') {
        filtered = reports.filter(r => r.status === filter);
    }
    
    document.getElementById('k3List').innerHTML = renderK3List(filtered);
}

function updateK3Status(reportId, status) {
    const reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
    const reportIndex = reports.findIndex(r => r.id === reportId);
    
    if (reportIndex !== -1) {
        reports[reportIndex].status = status;
        reports[reportIndex].updatedAt = new Date().toISOString();
        localStorage.setItem('k3_reports', JSON.stringify(reports));
        
        showNotification(`âœ… K3 report ${status === 'closed' ? 'closed' : 'updated'}!`, 'success');
        viewK3Reports();
    }
}

function viewInventory() {
    showView('inventory');
}

function openArchitectTools() {
    if (!appState.isArchitect) return;
    
    const content = `
        <div class="card">
            <h3 style="color: var(--quantum); margin-bottom: 1.5rem;">âš¡ Architect Tools</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <button onclick="manageUsers()" class="architect-btn">
                    <div style="font-size: 2rem;">ğŸ‘¥</div>
                    <div>Manage Users</div>
                </button>
                <button onclick="systemLogs()" class="architect-btn">
                    <div style="font-size: 2rem;">ğŸ“Š</div>
                    <div>System Logs</div>
                </button>
                <button onclick="databaseTools()" class="architect-btn">
                    <div style="font-size: 2rem;">ğŸ—„ï¸</div>
                    <div>Database</div>
                </button>
                <button onclick="backupSystem()" class="architect-btn">
                    <div style="font-size: 2rem;">ğŸ’¾</div>
                    <div>Backup</div>
                </button>
            </div>
            
            <!-- System Commands -->
            <div style="margin-top: 1.5rem;">
                <h4 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ”§ System Commands</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <button onclick="clearLocalStorage()" style="padding: 0.7rem 1rem; background: rgba(244,67,54,0.1); border: 1px solid #f44336; color: #f44336; border-radius: 5px;">Clear Storage</button>
                    <button onclick="resetAllData()" style="padding: 0.7rem 1rem; background: rgba(255,152,0,0.1); border: 1px solid #FF9800; color: #FF9800; border-radius: 5px;">Reset Data</button>
                    <button onclick="exportAllData()" style="padding: 0.7rem 1rem; background: rgba(76,175,80,0.1); border: 1px solid #4CAF50; color: #4CAF50; border-radius: 5px;">Export All</button>
                    <button onclick="testSupabase()" style="padding: 0.7rem 1rem; background: rgba(33,150,243,0.1); border: 1px solid #2196F3; color: #2196F3; border-radius: 5px;">Test Supabase</button>
                </div>
            </div>
        </div>
        
        <style>
            .architect-btn {
                padding: 1.5rem 0.5rem; background: rgba(156,39,176,0.1); 
                border: 2px solid var(--quantum); color: white; 
                border-radius: 15px; cursor: pointer; transition: all 0.3s;
                display: flex; flex-direction: column; align-items: center;
            }
            .architect-btn:hover {
                transform: translateY(-5px); background: rgba(156,39,176,0.2);
            }
        </style>
    `;
    
    document.getElementById('content').innerHTML = content;
}

function exportData() {
    const data = {
        bookings: JSON.parse(localStorage.getItem('bookings') || '[]'),
        k3_reports: JSON.parse(localStorage.getItem('k3_reports') || '[]'),
        inventory: JSON.parse(localStorage.getItem('inventory') || JSON.stringify(COMPLETE_DATA.equipment)),
        users: JSON.parse(localStorage.getItem('users') || '[]'),
        exportDate: new Date().toISOString(),
        version: CONFIG.version,
        system: 'DREAM OS v4.2'
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `dream-os-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('ğŸ’¾ Data exported successfully!', 'success');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (data.bookings) localStorage.setItem('bookings', JSON.stringify(data.bookings));
                if (data.k3_reports) localStorage.setItem('k3_reports', JSON.stringify(data.k3_reports));
                if (data.inventory) localStorage.setItem('inventory', JSON.stringify(data.inventory));
                if (data.users) localStorage.setItem('users', JSON.stringify(data.users));
                
                showNotification('ğŸ“¥ Data imported successfully!', 'success');
                showView('admin');
            } catch (error) {
                showNotification('âŒ Error importing data: ' + error.message, 'error');
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

function systemReset() {
    if (confirm('âš ï¸ Are you sure? This will reset all data to defaults.')) {
        localStorage.clear();
        initLocalStorage();
        showNotification('ğŸ”„ System reset complete!', 'success');
        showView('home');
    }
}

// ==================== SUPABASE FUNCTIONS ====================
async function saveToSupabase(table, data) {
    if (!supabaseClient) return;
    
    try {
        const { error } = await supabaseClient
            .from(table)
            .insert([data]);
        
        if (error) throw error;
        console.log(`âœ… Data saved to Supabase: ${table}`);
    } catch (error) {
        console.error('âŒ Supabase save error:', error);
    }
}

async function syncToCloud() {
    if (!supabaseClient) {
        showNotification('âŒ Supabase not connected', 'error');
        return;
    }
    
    showNotification('ğŸ”„ Syncing to cloud...', 'info');
    
    try {
        // Sync bookings
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        for (const booking of bookings) {
            await saveToSupabase('bookings', booking);
        }
        
        // Sync K3 reports
        const k3Reports = JSON.parse(localStorage.getItem('k3_reports') || '[]');
        for (const report of k3Reports) {
            await saveToSupabase('k3_reports', report);
        }
        
        // Sync inventory
        const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
        for (const item of inventory) {
            await saveToSupabase('inventory', item);
        }
        
        showNotification('âœ… Sync complete!', 'success');
    } catch (error) {
        showNotification('âŒ Sync error: ' + error.message, 'error');
    }
}

// ==================== WHATSAPP FUNCTION ====================
function sendToWhatsApp(message) {
    const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// ==================== INITIAL LOAD ====================
setInterval(updateGreeting, 60000);
setInterval(checkQuantumHours, 300000); // Check every 5 minutes

console.log('ğŸŒŒ DREAM OS v4.2 FINAL - Ready to use!');
console.log('ğŸ“± Mobile Optimized');
console.log('ğŸ’¾ LocalStorage Ready');
console.log('â˜ï¸ Supabase Integration: ' + (supabaseClient ? 'Connected' : 'Offline'));
console.log('ğŸ“ WhatsApp Integration Active');
console.log('ğŸ” Security System Active');
console.log('âœ… All systems go!');
    </script>
</body>
</html>
